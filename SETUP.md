# Инструкция по настройке

## Шаги настройки

### 1. Создание Google Apps Script проекта

1. Откройте Google Таблицу, в которую нужно выгружать данные
2. Перейдите в меню: **Расширения → Apps Script**
3. Скопируйте все файлы `.gs` из этого проекта в редактор Apps Script
4. Сохраните проект (Ctrl+S)

### 2. Настройка свойств скрипта

В редакторе Apps Script:

1. Перейдите в меню: **Проект → Настройки проекта** (или **File → Project settings**)
2. Найдите раздел **Свойства скрипта** (Script Properties)
3. Добавьте следующие свойства:

   - **SPREADSHEET_ID** - ID вашей Google Таблицы
     - Чтобы получить ID: откройте таблицу, посмотрите URL: `https://docs.google.com/spreadsheets/d/ВАШ_ID_ТУТ/edit`
   
   - **WB_API_TOKEN** - API токен Wildberries
     - Получите токен в личном кабинете Wildberries: **Настройки → Доступ к API**
     - Формат: `Bearer YOUR_TOKEN` или просто `YOUR_TOKEN` (скрипт добавит Bearer автоматически)

### 3. Создание листов в таблице

1. В Google Таблице создайте листы:
   - **"Ежедневные фин отчеты"** - для финансовых отчетов
   - **"Лента заказов"** - для заказов
   - **"Остатки"** - для остатков товаров
   - **"Аналитика РК"** - для аналитики рекламных кампаний
   - **"История рекламных расходов"** - для истории затрат на РК
   - **"Аналитика продавца"** - для статистики карточек товаров
2. Листы будут автоматически заполнены заголовками при первом запуске

### 4. Настройка триггеров (автоматический запуск)

#### 4.1. Триггер для ежедневных финансовых отчетов

1. В редакторе Apps Script перейдите: **Триггеры → Добавить триггер** (или **Triggers → Add Trigger**)
2. Настройте триггер:
   - **Выполнять функцию:** `runFinanceDailySync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 02:00 - 03:00 ночи)
3. Сохраните триггер

#### 4.2. Триггер для ленты заказов

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runOrdersFeedSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 02:30 - 03:30 ночи, после финансовых отчетов)
3. Сохраните триггер

#### 4.3. Триггер для остатков товаров

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runStocksSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 01:00 - 02:00 ночи)
3. Сохраните триггер

#### 4.4. Триггер для аналитики рекламных кампаний

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runAdsAnalyticsSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 03:00 - 04:00 ночи)
3. Сохраните триггер

#### 4.5. Триггер для истории рекламных расходов

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runAdsCostsSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 03:30 - 04:30 ночи, после аналитики РК)
3. Сохраните триггер

#### 4.6. Триггер для аналитики продавца

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runSalesFunnelSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 04:00 - 05:00 ночи, после истории рекламных расходов)
3. Сохраните триггер

### 5. Тестовый запуск

#### 5.1. Тест финансовых отчетов

1. В редакторе Apps Script выберите функцию `manualFinanceDailySync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения: **Выполнение → Просмотр журналов выполнения** (или **Execution → View execution logs**)
4. Проверьте данные в Google Таблице

#### 5.2. Тест ленты заказов

1. В редакторе Apps Script выберите функцию `manualOrdersFeedSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице

#### 5.3. Тест остатков товаров

1. В редакторе Apps Script выберите функцию `manualStocksSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице

#### 5.4. Тест аналитики рекламных кампаний

1. В редакторе Apps Script выберите функцию `manualAdsAnalyticsSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице на листе "Аналитика РК"

#### 5.5. Тест истории рекламных расходов

1. В редакторе Apps Script выберите функцию `manualAdsCostsSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице на листе "История рекламных расходов"

#### 5.6. Тест аналитики продавца

1. В редакторе Apps Script выберите функцию `manualSalesFunnelSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице на листе "Аналитика продавца"

## Структура проекта

- `Code.gs` - Главный файл с функциями запуска
- `config.gs` - Конфигурация проекта
- `dateUtils.gs` - Утилиты для работы с датами
- `sheets.gs` - Утилиты для работы с Google Sheets
- `wbApi.gs` - Модуль для работы с API Wildberries
- `reports/financeDaily.gs` - Модуль ежедневных финансовых отчетов
- `reports/ordersFeed.gs` - Модуль ленты заказов
- `reports/stocks.gs` - Модуль остатков товаров
- `reports/adsAnalytics.gs` - Модуль аналитики рекламных кампаний
- `reports/adsCosts.gs` - Модуль истории рекламных расходов
- `reports/salesFunnel.gs` - Модуль воронки продаж

## Важные замечания

1. **Лимиты API:** API Wildberries имеет лимит 1 запрос в минуту. Скрипт автоматически делает паузу между запросами при пагинации.

2. **Проверка дубликатов:** 
   - Для финансовых отчетов: скрипт проверяет, не загружены ли уже данные за предыдущий день
   - Для ленты заказов: множественные строки на день разрешены, так как API может возвращать обновленные данные
   - Для остатков: данные полностью перезаписываются при каждом запуске

3. **Часовой пояс:** Все даты обрабатываются в часовом поясе Москва (UTC+3).

4. **Обработка ошибок:** Ошибки логируются, но не прерывают выполнение других триггеров.

5. **Лента заказов:** Используется flag=1 для получения всех заказов за указанную дату за один запрос.

6. **Остатки товаров:** 
   - Используется endpoint `/api/v1/warehouse_remains` (трехэтапный процесс)
   - Данные полностью перезаписываются при каждом запуске (не дозаписываются)
   - Лимит API: 3 запроса в минуту с интервалом 20 секунд

7. **Аналитика рекламных кампаний:**
   - Используются endpoints `/api/advert/v2/adverts` (список кампаний) и `/adv/v3/fullstats` (статистика)
   - Данные дозаписываются ежедневно за предыдущий день
   - Обрабатываются только кампании со статусами 7 (завершена), 9 (активна), 11 (на паузе)
   - Проверяется наличие данных для каждой кампании за дату (уникальный ключ: campaignId + date)
   - Лимит API: 3 запроса в минуту с интервалом 20 секунд для статистики

9. **История рекламных расходов:**
   - Используется endpoint `/adv/v1/upd` (история фактических затрат на рекламные кампании)
   - Данные дозаписываются ежедневно за предыдущий день
   - Формирует список всех затрат с детализацией по документам списания
   - Возвращает данные о номере документа, времени списания, сумме, источнике списания (Баланс/Бонусы/Счёт/Кэшбэк)
   - Проверяется наличие данных за дату перед записью
   - Лимит API: 1 запрос в секунду (всплеск до 5 запросов)
   - Минимальный период запроса: 1 день, максимальный: 31 день

10. **Аналитика продавца (статистика карточек товаров):**
   - Используется endpoint `/api/analytics/v3/sales-funnel/products` (POST запрос)
   - Данные дозаписываются ежедневно за предыдущий день
   - Формирует отчет о товарах с показателями воронки продаж
   - Период сравнения: такая же дата год назад
   - Включает метрики: переходы в карточку, добавления в корзину, заказы, выкупы, отмены
   - Показывает данные по WB Клубу и разницу с прошлым периодом
   - Проверяется наличие данных для каждого товара за дату (уникальный ключ: nmId + date)
   - Лимит API: 3 запроса в минуту с интервалом 20 секунд
   - Поддерживает пагинацию (до 1000 товаров на страницу)

## Столбцы в таблицах

### Ежедневные фин отчеты

Данные выгружаются в следующем порядке:
Дата, rrd_id, gi_id, subject_name, nm_id, brand_name, sa_name, ts_name, barcode, doc_type_name, quantity, retail_price, retail_amount, sale_percent, commission_percent, office_name, supplier_oper_name, order_dt, sale_dt, rr_dt, shk_id, retail_price_withdisc_rub, delivery_amount, return_amount, delivery_rub, gi_box_type_name, product_discount_for_report, supplier_promo, rid, ppvz_spp_prc, ppvz_kvw_prc_base, ppvz_kvw_prc, ppvz_sales_commission, ppvz_for_pay, ppvz_reward, acquiring_fee, acquiring_bank, ppvz_vw, ppvz_vw_nds, ppvz_office_id, ppvz_office_name, ppvz_supplier_id, ppvz_supplier_name, ppvz_inn, declaration_number, bonus_type_name, sticker_id, site_country, penalty, additional_payment, rebill_logistic_cost, rebill_logistic_org, kiz, storage_fee, deduction, acceptance, srid

### Лента заказов

Данные выгружаются в следующем порядке:
№ позиции, Баркод, Наименование товара, Артикул поставщика/цвет, Артикул WB, Размер, Цена, Склад отправки, Регион доставки, Время заказа, Обновление, КОЛ_ВО

### Остатки

Данные выгружаются в следующем порядке:
Бренд, Предмет, Артикул продавца, Артикул WB, Объем л, Баркод, Размер вещи, В пути до получателей, В пути возвраты на склад WB, Всего находится на складах, и затем столбцы с названиями складов (Коледино, Подольск, Казань, и т.д.)

### Аналитика рекламных кампаний

Данные выгружаются в следующем порядке:
Дата выгрузки, Тип РК, ID РК, Название, Статус, Тип оплаты, Период начало, Период конец, Показы, Клики, CTR, CPC, Затраты, Добавления в корзину, Заказы, CR, Заказано товаров шт, Сумма заказов, Отмены

### История рекламных расходов

Данные выгружаются в следующем порядке:
ID кампании, Название кампании, Раздел (bid_type), Дата, Списания, Источник списания, Сумма, Номер документа

### Аналитика продавца

Данные выгружаются в следующем порядке:
Дата, Артикул продавца, Номенклатура, Название, Категория, Бренд, Удаленный товар, Рейтинг карточки, Переходы в карточку, Переходы в карточку (предыдущий период), Положили в корзину, Положили в корзину (предыдущий период), Заказали (шт), Заказали (шт) (предыдущий период), Выкупили (шт), Выкупы (шт) (предыдущий период), Отменили (шт), Отменили (шт) (предыдущий период), Конверсия в корзину (%), Конверсия в корзину (%) (предыдущий период), Конверсия в заказ (%), Конверсия в заказ (%) (предыдущий период), Процент выкупа, Процент выкупа (предыдущий период), Заказали на сумму (руб), Заказали на сумму (руб) (предыдущий период), Динамика суммы заказов (руб), Выкупили на сумму (руб), Выкупили на сумму (руб) (предыдущий период), Отменили на сумму (руб), Отменили на сумму (руб) (предыдущий период), Средняя цена (руб), Средняя цена (руб) (предыдущий период), Среднее количество заказов в день (шт), Среднее количество заказов в день (шт) (предыдущий период), Остатки склад ВБ (шт), Остатки МП (шт), Сумма остатков на складах (руб), Среднее время доставки, Среднее время доставки (предыдущий период), Локальные заказы (%), Локальные заказы (%) (предыдущий период)
