# Инструкция по настройке

## Шаги настройки

### 1. Создание Google Apps Script проекта

1. Откройте Google Таблицу, в которую нужно выгружать данные
2. Перейдите в меню: **Расширения → Apps Script**
3. Скопируйте все файлы `.gs` из этого проекта в редактор Apps Script
4. Сохраните проект (Ctrl+S)

### 2. Настройка свойств скрипта

В редакторе Apps Script:

1. Перейдите в меню: **Проект → Настройки проекта** (или **File → Project settings**)
2. Найдите раздел **Свойства скрипта** (Script Properties)
3. Добавьте следующие свойства:

   - **SPREADSHEET_ID** - ID вашей Google Таблицы
     - Чтобы получить ID: откройте таблицу, посмотрите URL: `https://docs.google.com/spreadsheets/d/ВАШ_ID_ТУТ/edit`
   
   - **WB_API_TOKEN** - API токен Wildberries
     - Получите токен в личном кабинете Wildberries: **Настройки → Доступ к API**
     - Формат: `Bearer YOUR_TOKEN` или просто `YOUR_TOKEN` (скрипт добавит Bearer автоматически)

### 3. Создание листов в таблице

1. В Google Таблице создайте листы:
   - **"Ежедневные фин отчеты"** - для финансовых отчетов
   - **"Лента заказов"** - для заказов
   - **"Остатки"** - для остатков товаров
2. Листы будут автоматически заполнены заголовками при первом запуске

### 4. Настройка триггеров (автоматический запуск)

#### 4.1. Триггер для ежедневных финансовых отчетов

1. В редакторе Apps Script перейдите: **Триггеры → Добавить триггер** (или **Triggers → Add Trigger**)
2. Настройте триггер:
   - **Выполнять функцию:** `runFinanceDailySync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 02:00 - 03:00 ночи)
3. Сохраните триггер

#### 4.2. Триггер для ленты заказов

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runOrdersFeedSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 02:30 - 03:30 ночи, после финансовых отчетов)
3. Сохраните триггер

#### 4.3. Триггер для остатков товаров

1. Добавьте еще один триггер:
   - **Выполнять функцию:** `runStocksSync`
   - **Источник события:** По времени
   - **Тип события:** Ежедневно
   - **Время:** Выберите удобное время (например, 01:00 - 02:00 ночи)
3. Сохраните триггер

### 5. Тестовый запуск

#### 5.1. Тест финансовых отчетов

1. В редакторе Apps Script выберите функцию `manualFinanceDailySync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения: **Выполнение → Просмотр журналов выполнения** (или **Execution → View execution logs**)
4. Проверьте данные в Google Таблице

#### 5.2. Тест ленты заказов

1. В редакторе Apps Script выберите функцию `manualOrdersFeedSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице

#### 5.3. Тест остатков товаров

1. В редакторе Apps Script выберите функцию `manualStocksSync`
2. Нажмите **Выполнить** (Run)
3. Проверьте логи выполнения
4. Проверьте данные в Google Таблице

## Структура проекта

- `Code.gs` - Главный файл с функциями запуска
- `config.gs` - Конфигурация проекта
- `dateUtils.gs` - Утилиты для работы с датами
- `sheets.gs` - Утилиты для работы с Google Sheets
- `wbApi.gs` - Модуль для работы с API Wildberries
- `reports/financeDaily.gs` - Модуль ежедневных финансовых отчетов
- `reports/ordersFeed.gs` - Модуль ленты заказов
- `reports/stocks.gs` - Модуль остатков товаров

## Важные замечания

1. **Лимиты API:** API Wildberries имеет лимит 1 запрос в минуту. Скрипт автоматически делает паузу между запросами при пагинации.

2. **Проверка дубликатов:** 
   - Для финансовых отчетов: скрипт проверяет, не загружены ли уже данные за предыдущий день
   - Для ленты заказов: множественные строки на день разрешены, так как API может возвращать обновленные данные
   - Для остатков: данные полностью перезаписываются при каждом запуске

3. **Часовой пояс:** Все даты обрабатываются в часовом поясе Москва (UTC+3).

4. **Обработка ошибок:** Ошибки логируются, но не прерывают выполнение других триггеров.

5. **Лента заказов:** Используется flag=1 для получения всех заказов за указанную дату за один запрос.

6. **Остатки товаров:** 
   - Используется endpoint `/api/v2/stocks-report/products/products` для получения данных по товарам
   - Данные полностью перезаписываются при каждом запуске (не дозаписываются)
   - Лимит API: 3 запроса в минуту с интервалом 20 секунд

## Столбцы в таблицах

### Ежедневные фин отчеты

Данные выгружаются в следующем порядке:
Дата, rrd_id, gi_id, subject_name, nm_id, brand_name, sa_name, ts_name, barcode, doc_type_name, quantity, retail_price, retail_amount, sale_percent, commission_percent, office_name, supplier_oper_name, order_dt, sale_dt, rr_dt, shk_id, retail_price_withdisc_rub, delivery_amount, return_amount, delivery_rub, gi_box_type_name, product_discount_for_report, supplier_promo, rid, ppvz_spp_prc, ppvz_kvw_prc_base, ppvz_kvw_prc, ppvz_sales_commission, ppvz_for_pay, ppvz_reward, acquiring_fee, acquiring_bank, ppvz_vw, ppvz_vw_nds, ppvz_office_id, ppvz_office_name, ppvz_supplier_id, ppvz_supplier_name, ppvz_inn, declaration_number, bonus_type_name, sticker_id, site_country, penalty, additional_payment, rebill_logistic_cost, rebill_logistic_org, kiz, storage_fee, deduction, acceptance, srid

### Лента заказов

Данные выгружаются в следующем порядке:
№ позиции, Баркод, Наименование товара, Артикул поставщика/цвет, Артикул WB, Размер, Цена, Склад отправки, Регион доставки, Время заказа, Обновление, КОЛ_ВО

### Остатки

Данные выгружаются в следующем порядке:
Бренд, Предмет, Артикул продавца, Артикул WB, Объем л, Баркод, Размер вещи, В пути до получателей, В пути возвраты на склад WB, Всего находится на складах, и затем столбцы с названиями складов (Коледино, Подольск, Казань, и т.д.)
