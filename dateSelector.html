<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 500px;
      margin: 0 auto;
    }
    
    h2 {
      color: #333;
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
    }
    
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    input[type="date"]:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
    }
    
    .checkbox-group {
      margin-bottom: 20px;
    }
    
    .checkbox-item {
      margin-bottom: 10px;
    }
    
    .checkbox-item input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .checkbox-item label {
      display: inline;
      font-weight: normal;
      cursor: pointer;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 25px;
    }
    
    button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-primary {
      background-color: #4285f4;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #3367d6;
    }
    
    .btn-primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #f1f3f4;
      color: #5f6368;
    }
    
    .btn-secondary:hover {
      background-color: #e8eaed;
    }
    
    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      display: none;
      font-size: 14px;
    }
    
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .select-all {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .note {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìÖ –í—ã–±–æ—Ä –¥–∞—Ç—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h2>
    
    <div class="form-group">
      <label for="reportDate">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:</label>
      <input type="date" id="reportDate" required>
      <div class="note">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, –∑–∞ –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç—ã.<br>
      –î–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–æ—Ä–æ–Ω–∫–∏: –≤—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (–∫–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏)</div>
    </div>
    
    <div class="checkbox-group">
      <div class="select-all">
        <div class="checkbox-item">
          <input type="checkbox" id="selectAll" onchange="toggleAll(this)">
          <label for="selectAll"><strong>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã</strong></label>
        </div>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="stocks" value="stocks">
        <label for="stocks">–û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</label>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="financeDaily" value="financeDaily">
        <label for="financeDaily">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã</label>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="ordersFeed" value="ordersFeed">
        <label for="ordersFeed">–õ–µ–Ω—Ç–∞ –∑–∞–∫–∞–∑–æ–≤</label>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="adsAnalytics" value="adsAnalytics">
        <label for="adsAnalytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –†–ö</label>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="salesFunnel" value="salesFunnel">
        <label for="salesFunnel">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞</label>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="funnelDynamic" value="funnelDynamic">
        <label for="funnelDynamic">–í–æ—Ä–æ–Ω–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∞ (–¥–æ–±–∞–≤–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü)</label>
      </div>
      
      <div class="checkbox-item">
        <input type="checkbox" class="report-checkbox" id="funnelDynamicWeek" value="funnelDynamicWeek">
        <label for="funnelDynamicWeek">–í–æ—Ä–æ–Ω–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∞ (–¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É)</label>
      </div>
    </div>
    
    <div class="button-group">
      <button type="button" class="btn-secondary" onclick="google.script.host.close()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" class="btn-primary" id="syncButton" onclick="startSync()">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    
    <div id="status" class="status"></div>
  </div>
  
  <script>
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    window.onload = function() {
      console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      var today = new Date();
      today.setDate(today.getDate() - 1);
      var yesterday = today.toISOString().split('T')[0];
      document.getElementById('reportDate').value = yesterday;
      console.log('–î–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', yesterday);
    };
    
    function toggleAll(checkbox) {
      var checkboxes = document.querySelectorAll('.report-checkbox');
      checkboxes.forEach(function(cb) {
        cb.checked = checkbox.checked;
      });
    }
    
    function startSync() {
      console.log('startSync –≤—ã–∑–≤–∞–Ω–∞');
      var date = document.getElementById('reportDate').value;
      console.log('–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞:', date);
      
      if (!date) {
        showStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', 'error');
        return;
      }
      
      // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
      var selectedReports = [];
      var checkboxes = document.querySelectorAll('.report-checkbox:checked');
      checkboxes.forEach(function(cb) {
        selectedReports.push(cb.value);
      });
      
      console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç—ã:', selectedReports);
      
      if (selectedReports.length === 0) {
        showStatus('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç—á–µ—Ç', 'error');
        return;
      }
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      var button = document.getElementById('syncButton');
      button.disabled = true;
      button.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
      
      showStatus('–ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞ ' + formatDate(date) + '...', 'info');
      
      console.log('–í—ã–∑–æ–≤ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ syncReportsByDate');
      
      // –í—ã–∑—ã–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onError)
        .syncReportsByDate(date, selectedReports);
    }
    
    function onSuccess(result) {
      console.log('onSuccess –≤—ã–∑–≤–∞–Ω–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', result);
      var button = document.getElementById('syncButton');
      button.disabled = false;
      button.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
      
      if (result && result.success) {
        showStatus('‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! ' + result.message, 'success');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(function() {
          google.script.host.close();
        }, 2000);
      } else {
        var errorMsg = result && result.message ? result.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        showStatus('‚úó –û—à–∏–±–∫–∞: ' + errorMsg, 'error');
      }
    }
    
    function onError(error) {
      console.error('onError –≤—ã–∑–≤–∞–Ω–∞, –æ—à–∏–±–∫–∞:', error);
      var button = document.getElementById('syncButton');
      button.disabled = false;
      button.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
      
      var errorMsg = error && error.message ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      showStatus('‚úó –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + errorMsg, 'error');
      console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    }
    
    function showStatus(message, type) {
      var status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
    }
    
    function formatDate(dateStr) {
      var parts = dateStr.split('-');
      return parts[2] + '.' + parts[1] + '.' + parts[0];
    }
  </script>
</body>
</html>
