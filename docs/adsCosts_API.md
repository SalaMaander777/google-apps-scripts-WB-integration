# API История рекламных расходов

## Endpoint: GET /adv/v1/upd

**URL**: `https://advert-api.wildberries.ru/adv/v1/upd`

## Описание
Метод формирует список фактических затрат на рекламные кампании за заданный период.

## Лимиты API
| Период | Лимит | Интервал | Всплеск |
|--------|-------|----------|---------|
| 1 секунда | 1 запрос | 1 секунда | 5 запросов |

## Авторизация
- **Тип**: HeaderApiKey
- **Заголовок**: `Authorization: <WB_API_TOKEN>`

## Параметры запроса

### Query Parameters

| Параметр | Тип | Обязательный | Описание | Пример |
|----------|-----|--------------|----------|---------|
| `from` | string (date) | Да | Начало интервала | `from=2023-07-31` |
| `to` | string (date) | Да | Конец интервала (минимальный интервал 1 день, максимальный 31 день) | `to=2023-08-02` |

## Формат даты
- **Формат**: `YYYY-MM-DD`
- **Минимальный интервал**: 1 день
- **Максимальный интервал**: 31 день

## Пример запроса

```bash
GET https://advert-api.wildberries.ru/adv/v1/upd?from=2023-07-31&to=2023-08-02
Authorization: <WB_API_TOKEN>
Content-Type: application/json
```

## Ответ

### Статус: 200 (Успешно)

**Content-Type**: `application/json`

**Schema**: Array of objects

### Поля ответа

| Поле | Тип | Описание |
|------|-----|----------|
| `updNum` | integer | Номер выставленного документа |
| `updTime` | string или null (time-date) | Время списания в формате ISO 8601 |
| `updSum` | integer | Выставленная сумма (в копейках) |
| `advertId` | integer | ID кампании |
| `campName` | string | Название кампании |
| `advertType` | integer | Тип кампании |
| `paymentType` | string | Источник списания: Баланс, Бонусы, Счёт, Кэшбэк |
| `advertStatus` | integer | Статус кампании (см. таблицу статусов) |

### Статусы кампаний

| Код | Описание |
|-----|----------|
| -1 | Удалена (процесс удаления будет завершён в течение 10 минут) |
| 4 | Готова к запуску |
| 7 | Завершена |
| 8 | Отменена |
| 9 | Активна |
| 11 | На паузе |

## Пример ответа

```json
[
  {
    "updNum": 123456,
    "updTime": "2023-08-01T12:30:45Z",
    "updSum": 50000,
    "advertId": 789,
    "campName": "Летняя распродажа",
    "advertType": 1,
    "paymentType": "Баланс",
    "advertStatus": 9
  },
  {
    "updNum": 123457,
    "updTime": "2023-08-01T14:20:15Z",
    "updSum": 25000,
    "advertId": 790,
    "campName": "Акция на обувь",
    "advertType": 2,
    "paymentType": "Бонусы",
    "advertStatus": 11
  }
]
```

## Обработка ошибок

### Возможные коды ошибок

| Код | Описание |
|-----|----------|
| 400 | Неверные параметры запроса |
| 401 | Ошибка авторизации (неверный токен) |
| 429 | Превышен лимит запросов |
| 500 | Внутренняя ошибка сервера |

### Пример обработки ошибок в коде

```javascript
try {
  var response = fetchWBAPI(url, params);
  
  if (!response) {
    Logger.log('Нет данных по затратам на рекламу');
    return [];
  }
  
  // Обработка данных
  
} catch (error) {
  Logger.log('Ошибка при получении истории затрат: ' + error.toString());
  throw error;
}
```

## Использование в Google Apps Script

### Функция для получения данных

```javascript
/**
 * Получить историю затрат на рекламные кампании за период
 * @param {string} fromDate - Дата начала в формате YYYY-MM-DD
 * @param {string} toDate - Дата конца в формате YYYY-MM-DD
 * @return {Array<Object>} Массив истории затрат
 */
function getAdvertCostsHistory(fromDate, toDate) {
  var url = 'https://advert-api.wildberries.ru/adv/v1/upd';
  
  var params = {
    from: fromDate,
    to: toDate
  };
  
  return fetchWBAPI(url, params);
}
```

### Пример вызова

```javascript
// Получить данные за предыдущий день
var reportDate = getPreviousDay(); // '2023-08-01'
var costsData = getAdvertCostsHistory(reportDate, reportDate);

// Получить данные за период
var costsData = getAdvertCostsHistory('2023-07-31', '2023-08-02');

// Получить информацию о кампаниях для получения bid_type
var campaignIds = [123, 456, 789];
var campaignInfoMap = getCampaignInfoMap(campaignIds);
// Результат: {123: {bid_type: 'unified', name: 'Кампания 1', status: 9}, ...}
```

## Особенности реализации

### 1. Формат суммы
- API возвращает сумму в **копейках** (поле `updSum`)
- В таблицу записывается сумма в **рублях**: `updSum / 100`

### 2. Формат времени
- Поле `updTime` может быть `null` или содержать дату в формате ISO 8601
- Используется `Utilities.formatDate()` для форматирования в 'yyyy-MM-dd HH:mm:ss'

### 3. Получение bid_type
- Скрипт автоматически запрашивает информацию о кампаниях через `/api/advert/v2/adverts`
- Создается карта соответствия campaignId -> {bid_type, name, status}
- Обработка ведется батчами по 50 ID с соблюдением лимитов API (пауза 1 секунда между батчами)

### 4. Периоды запроса
- Минимальный период: 1 день (from = to)
- Максимальный период: 31 день
- Для ежедневной выгрузки за предыдущий день используйте: `from = to = getPreviousDay()`

### 5. Дубликаты
- Перед записью проверяется наличие данных за указанную дату (столбец D "Дата")
- Функция `dateExistsInAdsCostsSheet()` предотвращает дублирование

### 6. Соблюдение лимитов
- История затрат API: 1 запрос в секунду (всплеск до 5 запросов)
- Список кампаний API: 5 запросов в секунду
- При массовых запросах используется `Utilities.sleep()` для задержки

## Структура таблицы

### Заголовки листа "История рекламных расходов"

| Столбец | Название | Тип данных | Описание |
|---------|----------|------------|----------|
| A | ID кампании | Integer | advertId |
| B | Название кампании | String | campName |
| C | Раздел (bid_type) | String | Тип ставки кампании (unified/manual) |
| D | Дата | Date | Дата, за которую запрашиваются данные |
| E | Списания | DateTime | updTime (отформатированное) |
| F | Источник списания | String | paymentType (Баланс/Бонусы/Счёт/Кэшбэк) |
| G | Сумма | Number | updSum / 100 (в рублях) |
| H | Номер документа | Integer | updNum |

### Получение bid_type

Для получения информации о типе ставки (bid_type) скрипт дополнительно запрашивает данные о кампаниях через endpoint `/api/advert/v2/adverts`:
- Собирает уникальные ID кампаний из истории затрат
- Запрашивает информацию о кампаниях батчами по 50 ID
- Создает карту соответствия campaignId -> bid_type
- Добавляет bid_type в каждую строку отчета

**Возможные значения bid_type:**
- `unified` - Автоматическая стратегия
- `manual` - Ручное управление

## Связь с другими отчетами

### Использование в листе "Воронка отчет"

Данные из "История рекламных расходов" используются для расчета:

1. **Затраты на рекламу по артикулу** (строка 38):
   - Суммируются затраты по кампаниям, связанным с артикулом через лист "ID-АРТ"

2. **Затраты на рекламу по модели** (строка 39):
   - Суммируются затраты по всем кампаниям модели

3. **Расчетные метрики**:
   - CPO = Затраты / Заказы
   - CPS = Затраты / Выкупы
   - CPC = Затраты / Клики
   - ДРР = Затраты / Сумма заказов

### Связь с листом "ID-АРТ"

Для привязки затрат к конкретным артикулам используется справочный лист "ID-АРТ":
- Поле `advertId` из истории затрат → соответствует ID кампании в "ID-АРТ"
- Через "ID-АРТ" определяется артикул поставщика
- По артикулу фильтруются данные для расчета метрик

## Триггеры и расписание

### Рекомендуемое расписание
- **Периодичность**: Ежедневно
- **Время**: После 02:00 по Москве (когда данные за предыдущий день уже доступны)
- **Функция**: `syncAdsCosts()`

### Создание триггера

```javascript
function createAdsCostsTrigger() {
  // Удаляем старый триггер если есть
  var triggers = ScriptApp.getProjectTriggers();
  for (var i = 0; i < triggers.length; i++) {
    if (triggers[i].getHandlerFunction() === 'syncAdsCosts') {
      ScriptApp.deleteTrigger(triggers[i]);
    }
  }
  
  // Создаем новый триггер на 02:00 каждый день
  ScriptApp.newTrigger('syncAdsCosts')
    .timeBased()
    .atHour(2)
    .everyDays(1)
    .create();
}
```

## Примечания

1. **Задержка данных**: Данные за предыдущий день могут появиться с задержкой. Рекомендуется запускать синхронизацию после 02:00.

2. **Частичные данные**: API может вернуть частичные данные, если обработка ещё не завершена. В этом случае можно повторить запрос позже.

3. **Удаленные кампании**: Кампании со статусом -1 находятся в процессе удаления (до 10 минут). Их данные сохраняются в истории.

4. **Источники списания**: 
   - **Баланс** - основной баланс рекламного кабинета
   - **Бонусы** - бонусные средства от WB
   - **Счёт** - прямая оплата со счёта
   - **Кэшбэк** - кэшбэк от WB

5. **Валюта**: Все суммы указаны в российских рублях (RUB).
