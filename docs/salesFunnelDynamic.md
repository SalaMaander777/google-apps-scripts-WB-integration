# Воронка динамика

## Описание

Модуль для автоматического обновления листа "Воронка динамика" с добавлением столбцов с датами и формулами после выгрузки всех ежедневных отчетов.

## Функциональность

### Автоматическое добавление столбцов

После выгрузки всех отчетов за предыдущий день автоматически добавляется новый столбец с:
- Датой в строках 7 и 8 (формат DD.MM.YYYY)
- Формулами для расчета 42 метрик (строки 9-50)

**Важно:** Столбцы добавляются в **хронологическом порядке**:
- Новый столбец автоматически вставляется в нужное место
- Даты всегда располагаются от старых к новым (слева направо)
- При добавлении пропущенной даты, столбец вставится между существующими
- Если столбец с такой датой уже есть, он не добавляется повторно

### Структура листа

Лист должен содержать минимум 50 строк:

#### Служебные строки (1-6):
- Строка 1: Артикул WB (подтягивается из листа "Аналитика продавца")
- Строка 2: Артикул продавца (выпадающий список)
- Строка 3: Наименование товара
- Строка 4: Модель (часть артикула до слэша)
- Строка 5: Тип Рекламной Кампании (заголовок)
- Строка 6: Выпадающий список РК (ВСЕ, АРК, П+К)

#### Строки с датами (7-8):
- Строка 7: Дата с
- Строка 8: Дата до

#### Метрики (9-50):

**Заказы и продажи:**
- Строка 9: Заказы по артикулу
- Строка 10: Динамика заказов
- Строка 11: Сумма заказов по артикулу, руб
- Строка 12: Динамика суммы заказов
- Строка 13: Заказы по модели
- Строка 14: Динамика заказов по модели
- Строка 15: Сумма заказов по модели, руб
- Строка 16: Доля заказов артикула в группе по модели

**Выкупы:**
- Строка 17: Выкупы по артикулу
- Строка 18: Выкупы по модели
- Строка 19: Сумма выкупов по артикулу (фин отчет)
- Строка 20: Динамика выкупы артикул, руб
- Строка 21: Динамика выкупы модели, руб

**Возвраты:**
- Строка 22: Возвраты
- Строка 23: Сумма возвратов

**Конверсии:**
- Строка 24: % выкупа по артикулу, факт
- Строка 25: % выкупа по модели, факт
- Строка 26: CTR артикула

**Воронка продаж:**
- Строка 27: Переходы в карточку
- Строка 28: Показы реклама по цвету
- Строка 29: Динамика показов по цвету
- Строка 30: Клики реклама по цвету
- Строка 31: Показы реклама по модели
- Строка 32: Клики реклама по модели
- Строка 33: CTR модели
- Строка 34: Корзина
- Строка 35: Конверсия в корзину
- Строка 36: Конверсия в заказ
- Строка 37: Общий коэффициент

**Реклама и затраты:**
- Строка 38: Затраты на рекламу по артикулу
- Строка 39: Затраты на рекламу по модели
- Строка 40: CPO (Cost Per Order)
- Строка 41: CPC по артикулу
- Строка 42: CPC по модели
- Строка 43: CPS по артикулу
- Строка 44: CPS по модели
- Строка 45: ДРР фактическая от заказа цвета на цвет
- Строка 46: ДРР вмененная от выкупа цвета на цвет
- Строка 47: ДРР фактическая от выкупа цвет на цвет
- Строка 48: ДРР вмененная от выкупа цвета на модель
- Строка 49: ДРР вмененная всей модели
- Строка 50: Заказов на 1 клик, руб (по модели)

## Формулы

### Источники данных

Формулы используют данные из следующих листов:
- **Аналитика продавца** - статистика карточек товаров
- **Лента заказов** - информация о заказах
- **Ежедневные ф отчеты** - финансовые данные
- **Аналитика РК** - данные рекламных кампаний
- **История рекламных расходов** - расходы на рекламу

### Особенности формул

1. **Динамические формулы** - автоматически ссылаются на предыдущий столбец для расчета динамики
2. **Условные формулы** - учитывают фильтр по типу РК из ячейки A6
3. **Агрегация** - используют СУММЕСЛИМН для фильтрации по датам и артикулам
4. **Защита от ошибок** - все формулы обернуты в ЕСЛИОШИБКА

## Использование

### Автоматический запуск

Настройте отдельный триггер для функции `updateSalesFunnelDynamic()`:
- Запускается после завершения выгрузки всех отчетов
- Рекомендуемое время: через 30 минут после `runAllDailySync()`

### Ручной запуск

Через меню: **⚙️ Настройки скрипта → Обновить воронку динамики**

Или вызовом функции:
```javascript
manualUpdateSalesFunnelDynamic();
```

## Триггеры

Рекомендуется настроить два ежедневных триггера:

1. **Триггер для синхронизации отчетов** (`runAllDailySync`):
   - Запускается в 6:00 утра (после завершения обработки данных Wildberries)
   - Синхронизирует все отчеты последовательно

2. **Триггер для обновления воронки** (`updateSalesFunnelDynamic`):
   - Запускается в 6:30 утра (после завершения синхронизации отчетов)
   - Добавляет новый столбец в "Воронка динамика"

## Требования

1. Лист "Воронка динамика" должен быть создан заранее
2. Лист должен содержать минимум 50 строк с подписями в столбце A
3. Должны быть настроены и заполнены данными следующие листы:
   - Аналитика продавца
   - Лента заказов
   - Ежедневные ф отчеты
   - Аналитика РК
   - История рекламных расходов

## Ограничения

1. Столбцы располагаются в хронологическом порядке (старые даты слева, новые справа)
2. Формулы динамики требуют наличия предыдущего столбца (слева)
3. Для первого столбца или столбца, вставленного в начало, динамика будет возвращать 0 (из-за ЕСЛИОШИБКА)
4. Нельзя добавить столбец с датой, которая уже существует

## Будущие улучшения

- Добавление недельных столбцов (когда день = воскресенье)
- Автоматическая проверка структуры листа перед добавлением столбцов
- Архивация старых данных при превышении лимита столбцов
