# API Воронки продаж (Аналитика продавца)

## Описание

Отчет "Воронка продаж" выгружается через Wildberries Seller Analytics API с использованием трехэтапного процесса генерации отчетов.

## Endpoint

`https://seller-analytics-api.wildberries.ru/api/v2/nm-report/downloads`

## Требования

- **Токен:** Токен для категории "Аналитика"
- **Подписка:** Требуется подписка Джем
- **Лимиты:** 
  - 3 запроса в минуту с интервалом 20 секунд
  - Максимум 20 отчетов в сутки
- **Хранение:** Готовый отчет хранится 48 часов

## Трехэтапный процесс

### Шаг 1: Создание задания на генерацию отчета

**POST** `/api/v2/nm-report/downloads`

#### Request Body:
```json
{
  "id": "uuid-v4",
  "reportType": "DETAIL_HISTORY_REPORT",
  "userReportName": "Воронка продаж 2026-01-14",
  "params": {
    "nmIDs": [],
    "startDate": "2026-01-14",
    "endDate": "2026-01-14",
    "timezone": "Europe/Moscow",
    "aggregationLevel": "day"
  }
}
```

#### Параметры:
- `id` (string, required): UUID v4 отчета, генерируется самостоятельно
- `reportType` (string, required): Тип отчета - `DETAIL_HISTORY_REPORT` (воронка продаж по артикулам WB)
- `userReportName` (string, optional): Название отчета
- `params.nmIDs` (array, required): Артикулы WB (пустой массив = все товары)
- `params.startDate` (string, required): Начало периода (YYYY-MM-DD)
- `params.endDate` (string, required): Конец периода (YYYY-MM-DD)
- `params.timezone` (string, optional): Часовой пояс (по умолчанию Europe/Moscow)
- `params.aggregationLevel` (string, optional): Группировка данных - `day`, `week`, `month` (по умолчанию `day`)

#### Response:
- HTTP 200: Задание создано успешно (пустое тело ответа)
- HTTP 4xx/5xx: Ошибка

### Шаг 2: Проверка статуса готовности отчета

**GET** `/api/v2/nm-report/downloads?filter[downloadIds]={uuid}`

#### Response:
```json
{
  "data": [
    {
      "id": "uuid-v4",
      "status": "PROCESSING",
      "createdAt": "2026-01-14T10:00:00Z",
      "reportType": "DETAIL_HISTORY_REPORT"
    }
  ]
}
```

#### Статусы:
- `PROCESSING`: Отчет генерируется
- `DONE`: Отчет готов к скачиванию
- `FAILED`: Ошибка генерации (нужно создать повторное задание)

### Шаг 3: Скачивание готового отчета

**GET** `/api/v2/nm-report/downloads/file/{downloadId}`

#### Response:
- HTTP 200: ZIP архив с CSV файлом
- HTTP 204: Нет данных
- HTTP 404: Отчет не найден или устарел (>48 часов)

## Формат данных

### CSV структура

Отчет возвращается в ZIP архиве в формате CSV с разделителем `;` и кодировкой UTF-8.

#### Заголовки CSV (примерные):
- Дата
- Артикул WB (nmId)
- Артикул продавца (vendorCode)
- Наименование
- Предмет
- Бренд
- Открытий карточек (переходы в карточку)
- Добавлено в корзину
- Заказано товаров
- Заказано на сумму
- Выкупили товаров
- Выкупили на сумму

### Структура в Google Sheets

| Столбец | Название | Источник | Тип |
|---------|----------|----------|-----|
| 1 | Дата | date / Дата | Date |
| 2 | Артикул WB | nmId / Артикул WB | Number |
| 3 | Артикул продавца | vendorCode / Артикул продавца | String |
| 4 | Наименование | name / Наименование | String |
| 5 | Предмет | subject / Предмет | String |
| 6 | Бренд | brand / Бренд | String |
| 7 | Переходы в карточку | cardViews / Открытий карточек | Number |
| 8 | Положили в корзину | addedToCart / Добавлено в корзину | Number |
| 9 | Заказы | orders / Заказано товаров | Number |
| 10 | Заказы на сумму | ordersSum / Заказано на сумму | Number |
| 11 | Выкупы | buyouts / Выкупили товаров | Number |
| 12 | Выкупы на сумму | buyoutsSum / Выкупили на сумму | Number |

## Логика работы скрипта

1. **Проверка дубликатов**: Перед выгрузкой проверяется, есть ли уже данные за указанную дату (по столбцу "Дата")
2. **Создание отчета**: Генерируется UUID и создается задание на генерацию отчета
3. **Ожидание**: Каждые 10 секунд проверяется статус готовности (макс. 60 попыток = 10 минут)
4. **Скачивание**: Загружается ZIP архив, извлекается CSV файл
5. **Парсинг**: CSV парсится в массив объектов
6. **Форматирование**: Данные преобразуются в формат таблицы
7. **Дозапись**: Данные дозаписываются в конец листа "Аналитика продавца"

## Обработка ошибок

- Все ошибки API логируются в Logger
- При статусе `FAILED` выбрасывается исключение
- При превышении времени ожидания (10 минут) выбрасывается исключение
- Если данные за дату уже существуют, выгрузка пропускается

## Пример использования

### Ручной запуск
```javascript
manualSalesFunnelSync();
```

### Автоматический запуск (триггер)
```javascript
runSalesFunnelSync();
```

### Выгрузка за конкретную дату
```javascript
// Модифицировать функцию syncSalesFunnel() для передачи конкретной даты
```

## Ограничения API

1. Максимум 1000 артикулов в одном запросе (в params.nmIDs)
2. Максимум 20 отчетов в сутки
3. Период отчета - максимум 1 год
4. Отчет хранится только 48 часов после генерации
5. Требуется подписка Джем (кроме отчета по истории остатков)

## Дополнительные типы отчетов

API поддерживает и другие типы отчетов:
- `DETAIL_HISTORY_REPORT` - Воронка продаж по артикулам WB
- `CATEGORY_HISTORY_REPORT` - По предметам, брендам и ярлыкам
- `SEARCH_QUERY_REPORT` - По текстам поисковых запросов
- `STOCK_HISTORY_REPORT_CSV` - История остатков (не требует Джем)

## См. также

- [Техническое задание](ТЗ.md)
- [Инструкция по настройке](../SETUP.md)
